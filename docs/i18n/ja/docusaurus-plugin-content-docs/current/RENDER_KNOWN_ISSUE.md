---
title: レンダーの既知問題
sidebar_position: 6
---

# Render known issues (描画関連)

## 前提

- レンダーは headless Chromium（`chromiumoxide`）で実行されます（`render/src/main.rs`）。
- フレーム固定は `window.__frameScript.setFrame(frame)` で行います（`src/lib/frame.tsx`）。
- 映像素材の一部は `waitCanvasFrame(frame)` を通じて「指定フレームの描画完了」を待てます（`src/lib/video/video-render.tsx`）。

## 既知の問題と回避策

### 1) `backdrop-filter`（ガラス表現）で欠け・ちらつきが出る

**症状**

- ある特定フレーム付近で、パネルの一部が「欠ける」「チラつく」「一瞬だけ未描画になる」。
- 何度レンダーしても、だいたい同じフレームで発生することがある。

**原因（推定）**

- `backdrop-filter` は背面をサンプリングしてぼかすため、合成パスが複雑になります。
- headless Chromium では、`backdrop-filter` + `transform` の組み合わせで、タイル単位の合成が不安定になり、中間状態がスクリーンショットに写ることがあります。

**回避策**

- レンダー時だけ `backdrop-filter` を無効化する（最も確実）。
  - 本リポジトリでは `GlassPanel` がレンダー時に `backdrop-filter` を `none` に切り替えています（`project/components/panels.tsx`）。
- レンダーでの再現性を優先する場合、次の表現も避けるのが安全です:
  - `filter: blur(...)` / `drop-shadow(...)` の多用
  - 大きな要素への `transform` とフィルタの同時使用

### 2) 3D/WebGL を使うと環境差やちらつきが出る可能性が高い

**症状**

- 環境（GPU/ドライバ/headlessの描画パス）によって見た目が微妙に変わる。
- 特定フレームだけ欠ける/破綻する、アンチエイリアスやシャドウが揺らぐ。

**原因（推定）**

- WebGL は GPU と合成処理に強く依存し、headless Chromium では描画パスが異なることがあります。

**回避策（方針）**

- レンダー専用に「安定する表現」へ落とす設計を用意する。
- 可能なら「描画完了」を確実に待つ仕組みを用意する（例: `waitCanvasFrame` の 3D 対応強化など）。

### 3) CSS アニメーションが currentFrame に追従しない / 不安定になる

**症状**

- スクラブ/レンダー時に CSS アニメーションが「実時間で動く」「止まらない」「フレームと同期しない」。

**原因**

- CSS アニメーションは通常、壁時計（real time）で進みます。

**対策**

- `Clip` 配下の CSS アニメーションは `pause()` して `currentTime` を `currentFrame` ベースで上書きし、スクラブ/レンダーでも決定的になるようにしています（`src/lib/clip.tsx`）。

**注意**

- `infinite` などのアニメーションは「見た目の意図」と「フレーム固定」のどちらを優先するかで設計方針が変わります。
- 表現によっては「レンダー専用の見た目」を用意するほうが安全です（例: `useIsRender()` で分岐）。

### 4) 素材読み込みが間に合わず、数フレームだけ空になる

**症状**

- 動画/画像/フォントなどが読み込み途中のフレームがキャプチャされ、数フレームだけ表示が崩れる。

**原因**

- フレーム固定しても、リソースの読み込みは非同期で進むため、読み込み完了前にスクショが撮られることがあります。

**回避策**

- 可能ならフレームごとの「描画完了待ち」を行う（`waitCanvasFrame` など）。
- 追加したリソースがある場合、レンダー側で「読み込み完了を待つ」仕組みを検討する。

## Debug / 切り分けのコツ

- 再現フレームが固定なら:
  - そのフレーム周辺で `transform`/filter/backdrop-filter の組み合わせを疑う。
  - 該当要素の `backdrop-filter` を一時的に外して再レンダーし、現象が消えるか確認する。
- プレビューでは再現しない場合:
  - headless Chromium 特有の合成/フォント/タイミング差を疑う（「レンダー時のみ」分岐が有効なことが多い）。
